<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIBOK Admin - Dashboard Complet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-user-shield text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">TIBOK Medical Evaluation</h1>
                        <p class="text-blue-200 text-sm">Dashboard Administrateur</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="api-status" class="px-3 py-1 bg-yellow-500 text-white rounded-full text-sm">
                        <i class="fas fa-exclamation-triangle mr-1"></i>API non configur√©e
                    </span>
                    <button onclick="location.href='/static/index.html'" class="px-4 py-2 bg-white text-blue-600 rounded-lg hover:bg-blue-50">
                        <i class="fas fa-home mr-2"></i>Accueil
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4">
            <nav class="flex space-x-1">
                <button onclick="showTab('dashboard')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="dashboard">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="showTab('doctors')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="doctors">
                    <i class="fas fa-users mr-2"></i>M√©decins
                </button>
                <button onclick="showTab('ranking')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="ranking">
                    <i class="fas fa-trophy mr-2"></i>Classement
                </button>
                <button onclick="showTab('content')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="content">
                    <i class="fas fa-book mr-2"></i>Contenu
                </button>
                <button onclick="showTab('evaluations-setup')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="evaluations-setup">
                    <i class="fas fa-clipboard-list mr-2"></i>Cr√©er √âvaluation
                </button>
                <button onclick="showTab('evaluations')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="evaluations">
                    <i class="fas fa-clipboard-check mr-2"></i>R√©sultats
                </button>
                <button onclick="showTab('config')" class="tab-btn px-6 py-3 font-medium text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600" data-tab="config">
                    <i class="fas fa-cog mr-2"></i>Configuration
                </button>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">M√©decins</p>
                            <p class="text-3xl font-bold text-blue-600" id="stat-doctors">0</p>
                        </div>
                        <i class="fas fa-users text-4xl text-blue-200"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">QCM</p>
                            <p class="text-3xl font-bold text-green-600" id="stat-qcm">0</p>
                        </div>
                        <i class="fas fa-question-circle text-4xl text-green-200"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Cas Cliniques</p>
                            <p class="text-3xl font-bold text-purple-600" id="stat-cases">0</p>
                        </div>
                        <i class="fas fa-file-medical text-4xl text-purple-200"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Alertes</p>
                            <p class="text-3xl font-bold text-red-600" id="stat-alerts">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-4xl text-red-200"></i>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">R√©partition par Statut</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Score Moyen par Sp√©cialit√©</h3>
                    <canvas id="specialtyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Doctors -->
        <div id="tab-doctors" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Gestion des M√©decins</h2>
                    <button onclick="showCreateDoctorModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Nouveau M√©decin
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nom</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Sp√©cialit√©</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Score T-MCQ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Statut</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="doctors-table-body" class="divide-y divide-gray-200">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Ranking -->
        <div id="tab-ranking" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-6">üèÜ Classement des M√©decins</h2>
                
                <div class="space-y-3" id="ranking-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Tab: Content -->
        <div id="tab-content" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Section QCM -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">üìù QCM</h2>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold" id="qcm-count">0 QCM</span>
                    </div>
                    
                    <div class="mb-4">
                        <button onclick="showGenerateQCMModal()" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 font-medium">
                            <i class="fas fa-magic mr-2"></i>G√©n√©rer un nouveau QCM (IA)
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-4">
                        <p class="font-semibold mb-2">Th√®mes disponibles :</p>
                        <div class="flex flex-wrap gap-2">
                            <span class="px-2 py-1 bg-gray-100 rounded">Hypertension</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">Diab√®te</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">COVID-19</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">P√©diatrie</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">Cardiologie</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">Dermatologie</span>
                        </div>
                    </div>
                </div>
                
                <!-- Section Cas Cliniques -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">ü©∫ Cas Cliniques</h2>
                        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold" id="case-count">0 Cas</span>
                    </div>
                    
                    <div class="mb-4">
                        <button onclick="showGenerateCaseModal()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 font-medium">
                            <i class="fas fa-magic mr-2"></i>G√©n√©rer un cas clinique (IA)
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-4">
                        <p class="font-semibold mb-2">Sp√©cialit√©s disponibles :</p>
                        <div class="flex flex-wrap gap-2">
                            <span class="px-2 py-1 bg-gray-100 rounded">M√©decine G√©n√©rale</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">Urgences</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">P√©diatrie</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">Cardiologie</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Liste des QCM -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Liste des QCM</h3>
                <div id="qcm-list" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Liste des Cas Cliniques -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Liste des Cas Cliniques</h3>
                <div id="case-list" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Tab: Evaluations Setup -->
        <div id="tab-evaluations-setup" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">üìã Gestion des √âvaluations</h2>
                    <button onclick="showCreateEvaluationModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        <i class="fas fa-plus mr-2"></i>Nouvelle √âvaluation
                    </button>
                </div>
                
                <div id="evaluations-list" class="space-y-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Tab: Evaluations -->
        <div id="tab-evaluations" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-bold mb-6">üìä Toutes les √âvaluations</h2>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">M√©decin</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Score T-MCQ</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">QCM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Cas Cliniques</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Statut</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="evaluations-table-body" class="divide-y divide-gray-200">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Analyse d√©taill√©e -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üìà √âvolution des Scores</h3>
                    <canvas id="evaluationTrendChart"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üéØ Th√®mes Probl√©matiques</h3>
                    <canvas id="weakPointsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Config -->
        <div id="tab-config" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-6">‚öôÔ∏è Configuration API OpenAI</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Cl√© API OpenAI
                    </label>
                    <div class="flex space-x-4">
                        <input type="password" id="api-key-input" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="sk-...">
                        <button onclick="toggleAPIKeyVisibility()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-eye" id="toggle-icon"></i>
                        </button>
                        <button onclick="saveAPIKey()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Enregistrer
                        </button>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Format: sk-proj-... (obtenir sur <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">platform.openai.com</a>)
                    </p>
                </div>

                <div id="api-key-status" class="p-4 rounded-lg hidden">
                    <!-- Status messages -->
                </div>

                <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-900 mb-2">üí° Pourquoi configurer la cl√© API ?</h3>
                    <ul class="text-sm text-blue-800 space-y-1">
                        <li>‚Ä¢ G√©n√©ration illimit√©e de QCM bas√©s sur guidelines OMS/WHO</li>
                        <li>‚Ä¢ Cr√©ation de cas cliniques r√©alistes</li>
                        <li>‚Ä¢ Audit automatique des t√©l√©consultations</li>
                        <li>‚Ä¢ D√©tection des red flags m√©dicaux</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Generate QCM -->
    <div id="generate-qcm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">‚ú® G√©n√©rer un QCM</h3>
                <button onclick="hideGenerateQCMModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form onsubmit="generateQCM(event)">
                <div class="space-y-4">
    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Th√®me m√©dical</label>
                        <select id="qcm-theme" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Choisir --</option>
                            <option value="Hypertension">Hypertension</option>
                            <option value="Diab√®te">Diab√®te Type 2</option>
                            <option value="COVID-19">COVID-19 et T√©l√©consultation</option>
                            <option value="P√©diatrie">P√©diatrie G√©n√©rale</option>
                            <option value="Cardiologie">Cardiologie</option>
                            <option value="Dermatologie">Dermatologie</option>
                            <option value="Psychiatrie">Psychiatrie/Sant√© Mentale</option>
                            <option value="Gyn√©cologie">Gyn√©cologie</option>
                            <option value="Endocrinologie">Endocrinologie</option>
                            <option value="Pneumologie">Pneumologie</option>
                            <option value="Gastroent√©rologie">Gastroent√©rologie</option>
                            <option value="Rhumatologie">Rhumatologie</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Difficult√©</label>
                        <select id="qcm-difficulty" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="easy">Facile (Questions de base)</option>
                            <option value="intermediate" selected>Interm√©diaire (Guidelines OMS)</option>
                            <option value="difficult">Difficile (Cas complexes)</option>
                        </select>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-xs text-blue-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Dur√©e estim√©e :</strong> 30-60 secondes
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="hideGenerateQCMModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-magic mr-2"></i>G√©n√©rer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Generate Clinical Case -->
    <div id="generate-case-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">‚ú® G√©n√©rer un Cas Clinique</h3>
                <button onclick="hideGenerateCaseModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form onsubmit="generateClinicalCase(event)">
                <div class="space-y-4">
    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sp√©cialit√©</label>
                        <select id="case-specialty" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">-- Choisir --</option>
                            <option value="M√©decine G√©n√©rale">M√©decine G√©n√©rale</option>
                            <option value="Urgences">Urgences</option>
                            <option value="P√©diatrie">P√©diatrie</option>
                            <option value="Cardiologie">Cardiologie</option>
                            <option value="Dermatologie">Dermatologie</option>
                            <option value="Endocrinologie">Endocrinologie</option>
                            <option value="Pneumologie">Pneumologie</option>
                            <option value="Gastroent√©rologie">Gastroent√©rologie</option>
                            <option value="Gyn√©cologie">Gyn√©cologie</option>
                            <option value="Psychiatrie">Psychiatrie</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Complexit√©</label>
                        <select id="case-complexity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="simple">Simple (Diagnostic √©vident)</option>
                            <option value="moderate" selected>Mod√©r√© (Diagnostic diff√©rentiel)</option>
                            <option value="complex">Complexe (Multi-pathologies)</option>
                        </select>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                        <p class="text-xs text-purple-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Dur√©e estim√©e :</strong> 45-90 secondes
                        </p>
                    </div>
                </div>

                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="hideGenerateCaseModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-magic mr-2"></i>G√©n√©rer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Create Evaluation -->
    <div id="create-evaluation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full mx-4 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">‚ú® Cr√©er une √âvaluation</h3>
                <button onclick="hideCreateEvaluationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form onsubmit="createEvaluation(event)">
                <!-- √âtape 1: Informations de base -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold mb-4 text-blue-600">1. Informations de base</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nom de l'√©valuation *</label>
                            <input type="text" id="eval-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: √âvaluation TIBOK - M√©decine G√©n√©rale 2025">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="eval-description" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Description de l'√©valuation (optionnel)"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dur√©e (minutes)</label>
                            <input type="number" id="eval-duration" value="60" min="10" max="180" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Score minimum (%)</label>
                            <input type="number" id="eval-passing-score" value="75" min="0" max="100" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- √âtape 2: S√©lection des QCM -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-green-600">2. S√©lectionner les QCM</h4>
                        <button type="button" onclick="loadAvailableQCM()" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">
                            <i class="fas fa-sync mr-1"></i>Actualiser
                        </button>
                    </div>
                    <div id="qcm-selection-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-500 text-center py-8">Chargement des QCM...</p>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="selected-qcm-count" class="font-semibold">0</span> QCM s√©lectionn√©(s)
                    </p>
                </div>

                <!-- √âtape 3: S√©lection des cas cliniques -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-purple-600">3. S√©lectionner les Cas Cliniques</h4>
                        <button type="button" onclick="loadAvailableCases()" class="px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm">
                            <i class="fas fa-sync mr-1"></i>Actualiser
                        </button>
                    </div>
                    <div id="cases-selection-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4">
                        <p class="text-gray-500 text-center py-8">Chargement des cas cliniques...</p>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="selected-cases-count" class="font-semibold">0</span> cas clinique(s) s√©lectionn√©(s)
                    </p>
                </div>

                <div class="flex justify-between items-center pt-6 border-t">
                    <button type="button" onclick="hideCreateEvaluationModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-check mr-2"></i>Cr√©er l'√âvaluation
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Create Doctor -->
    <div id="create-doctor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Nouveau M√©decin</h3>
                <button onclick="hideCreateDoctorModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form onsubmit="createDoctor(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom complet</label>
                        <input type="text" id="new-doctor-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Dr. Jean Martin">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="new-doctor-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="jean.martin@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sp√©cialit√©</label>
                        <select id="new-doctor-specialty" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Choisir --</option>
                            <option value="M√©decine G√©n√©rale">M√©decine G√©n√©rale</option>
                            <option value="P√©diatrie">P√©diatrie</option>
                            <option value="Cardiologie">Cardiologie</option>
                            <option value="Dermatologie">Dermatologie</option>
                            <option value="Psychiatrie">Psychiatrie</option>
                            <option value="Gyn√©cologie">Gyn√©cologie</option>
                            <option value="Urgences">Urgences</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe initial</label>
                        <input type="password" id="new-doctor-password" required minlength="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Minimum 8 caract√®res">
                    </div>
                </div>

                <div class="mt-6 flex space-x-3">
                    <button type="button" onclick="hideCreateDoctorModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-check mr-2"></i>Cr√©er
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentTab = 'dashboard';
        let statusChart = null;
        let specialtyChart = null;

        // Tab Management
        function showTab(tabName) {
            currentTab = tabName;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-600', 'text-blue-600');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Activate button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-600', 'text-blue-600');
            
            // Load data for tab
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'doctors') {
                loadDoctors();
            } else if (tabName === 'ranking') {
                loadRanking();
            } else if (tabName === 'content') {
                loadContent();
            } else if (tabName === 'evaluations-setup') {
                loadEvaluationsSetup();
            } else if (tabName === 'evaluations') {
                loadEvaluations();
            } else if (tabName === 'config') {
                loadConfig();
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stat-doctors').textContent = stats.total_doctors || 0;
                    document.getElementById('stat-qcm').textContent = stats.content?.total_qcm || 0;
                    document.getElementById('stat-cases').textContent = stats.content?.total_cases || 0;
                    document.getElementById('stat-alerts').textContent = stats.unresolved_alerts || 0;
                    
                    // Load charts
                    loadCharts();
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        // Load Charts
        async function loadCharts() {
            try {
                const response = await fetch(`${API_BASE}/admin/doctors`);
                const data = await response.json();
                
                if (!data.success) return;
                
                const doctors = data.doctors;
                
                // Status Chart
                const statusCounts = {
                    'apte': 0,
                    'supervision_requise': 0,
                    'formation_requise': 0,
                    'non_√©valu√©': 0
                };
                
                doctors.forEach(doc => {
                    const status = doc.evaluation_status || 'non_√©valu√©';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                
                if (statusChart) statusChart.destroy();
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Apte', 'Supervision', 'Formation', 'Non √©valu√©'],
                        datasets: [{
                            data: [
                                statusCounts.apte,
                                statusCounts.supervision_requise,
                                statusCounts.formation_requise,
                                statusCounts.non_√©valu√©
                            ],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
                
                // Specialty Chart
                const specialtyCounts = {};
                doctors.forEach(doc => {
                    const specialty = doc.specialty || 'Non sp√©cifi√©';
                    specialtyCounts[specialty] = (specialtyCounts[specialty] || 0) + 1;
                });
                
                if (specialtyChart) specialtyChart.destroy();
                const specialtyCtx = document.getElementById('specialtyChart').getContext('2d');
                specialtyChart = new Chart(specialtyCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(specialtyCounts),
                        datasets: [{
                            label: 'Nombre de m√©decins',
                            data: Object.values(specialtyCounts),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load charts:', error);
            }
        }

        // Load Doctors
        async function loadDoctors() {
            try {
                const response = await fetch(`${API_BASE}/admin/doctors`);
                const data = await response.json();
                
                if (!data.success) return;
                
                const tbody = document.getElementById('doctors-table-body');
                tbody.innerHTML = data.doctors.map(doctor => {
                    const statusBadge = getStatusBadge(doctor.evaluation_status);
                    const score = doctor.tmcq_total ? doctor.tmcq_total.toFixed(1) : 'N/A';
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">${doctor.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${doctor.email}</td>
                            <td class="px-4 py-3 text-sm">${doctor.specialty || 'N/A'}</td>
                            <td class="px-4 py-3 text-sm font-semibold">${score}</td>
                            <td class="px-4 py-3 text-sm">${statusBadge}</td>
                            <td class="px-4 py-3 text-sm">
                                <button onclick="viewDoctor('${doctor.id}')" class="text-blue-600 hover:text-blue-800 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editDoctor('${doctor.id}')" class="text-green-600 hover:text-green-800 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteDoctor('${doctor.id}', '${doctor.name}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load doctors:', error);
            }
        }

        // Load Ranking
        async function loadRanking() {
            try {
                const response = await fetch(`${API_BASE}/admin/ranking`);
                const data = await response.json();
                
                if (!data.success) return;
                
                const rankingList = document.getElementById('ranking-list');
                rankingList.innerHTML = data.ranking.map((doctor, index) => {
                    const score = doctor.tmcq_total ? doctor.tmcq_total.toFixed(1) : 'N/A';
                    const statusBadge = getStatusBadge(doctor.evaluation_status);
                    
                    let medalIcon = '';
                    if (index === 0) medalIcon = 'ü•á';
                    else if (index === 1) medalIcon = 'ü•à';
                    else if (index === 2) medalIcon = 'ü•â';
                    
                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <div class="flex items-center space-x-4">
                                <div class="text-2xl font-bold text-gray-400 w-8">${medalIcon || (index + 1)}</div>
                                <div>
                                    <div class="font-semibold text-gray-900">${doctor.name}</div>
                                    <div class="text-sm text-gray-500">${doctor.specialty || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                ${statusBadge}
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-blue-600">${score}</div>
                                    <div class="text-xs text-gray-500">Score T-MCQ</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load ranking:', error);
            }
        }

        // Load Config
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/admin/config`);
                const data = await response.json();
                
                if (data.success && data.config) {
                    const apiStatus = document.getElementById('api-status');
                    if (data.config.is_configured) {
                        apiStatus.innerHTML = '<i class="fas fa-check-circle mr-1"></i>API configur√©e';
                        apiStatus.className = 'px-3 py-1 bg-green-500 text-white rounded-full text-sm';
                        
                        document.getElementById('api-key-input').placeholder = data.config.config_value_masked;
                    }
                }
            } catch (error) {
                console.error('Failed to load config:', error);
            }
        }

        // Save API Key
        async function saveAPIKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            
            if (!apiKey) {
                showStatus('Veuillez entrer une cl√© API', 'error');
                return;
            }
            
            if (!apiKey.startsWith('sk-')) {
                showStatus('Format de cl√© invalide (doit commencer par sk-)', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus('‚úÖ Cl√© API enregistr√©e avec succ√®s', 'success');
                    document.getElementById('api-key-input').value = '';
                    loadConfig();
                } else {
                    showStatus('‚ùå ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Erreur lors de l\'enregistrement', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('api-key-status');
            statusDiv.textContent = message;
            statusDiv.className = `p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        function toggleAPIKeyVisibility() {
            const input = document.getElementById('api-key-input');
            const icon = document.getElementById('toggle-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Modal Management
        function showCreateDoctorModal() {
            document.getElementById('create-doctor-modal').classList.remove('hidden');
            document.getElementById('create-doctor-modal').classList.add('flex');
        }

        function hideCreateDoctorModal() {
            document.getElementById('create-doctor-modal').classList.add('hidden');
            document.getElementById('create-doctor-modal').classList.remove('flex');
        }

        // Create Doctor
        async function createDoctor(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-doctor-name').value;
            const email = document.getElementById('new-doctor-email').value;
            const specialty = document.getElementById('new-doctor-specialty').value;
            const password = document.getElementById('new-doctor-password').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/doctor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, specialty, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ M√©decin cr√©√© avec succ√®s');
                    hideCreateDoctorModal();
                    loadDoctors();
                } else {
                    alert('‚ùå ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la cr√©ation');
            }
        }

        // Delete Doctor
        async function deleteDoctor(doctorId, doctorName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${doctorName} ?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/doctor/${doctorId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ M√©decin supprim√©');
                    loadDoctors();
                } else {
                    alert('‚ùå ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la suppression');
            }
        }

        function viewDoctor(doctorId) {
            window.open(`/static/doctor-detail.html?id=${doctorId}`, '_blank');
        }

        function editDoctor(doctorId) {
            alert('Fonctionnalit√© √† venir');
        }

        // Load Content (QCM & Clinical Cases)
        async function loadContent() {
            try {
                // Load QCM
                const qcmResponse = await fetch(`${API_BASE}/admin/stats`);
                const qcmData = await qcmResponse.json();
                
                if (qcmData.success) {
                    const qcmCount = qcmData.stats.content?.total_qcm || 0;
                    const casesCount = qcmData.stats.content?.total_cases || 0;
                    
                    document.getElementById('qcm-count').textContent = `${qcmCount} QCM`;
                    document.getElementById('case-count').textContent = `${casesCount} Cas`;
                }
                
                // Load QCM list
                const qcmListResponse = await fetch(`${API_BASE}/generate/qcm/random?count=10`);
                const qcmList = await qcmListResponse.json();
                
                const qcmListDiv = document.getElementById('qcm-list');
                if (qcmList.qcms && qcmList.qcms.length > 0) {
                    qcmListDiv.innerHTML = qcmList.qcms.map(qcm => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">${qcm.theme}</h4>
                                    <p class="text-sm text-gray-600 mt-1">${qcm.question.substring(0, 100)}...</p>
                                    <div class="mt-2 flex items-center space-x-3 text-xs text-gray-500">
                                        <span><i class="fas fa-tag mr-1"></i>${qcm.difficulty || 'N/A'}</span>
                                        <span><i class="fas fa-book mr-1"></i>${qcm.source}</span>
                                    </div>
                                </div>
                                <button onclick="viewQCM('${qcm.id}')" class="ml-4 text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    qcmListDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun QCM disponible. G√©n√©rez-en un !</p>';
                }
                
                // Load Clinical Cases list
                const casesResponse = await fetch(`${API_BASE}/generate/clinical-case/random?count=5`);
                const casesList = await casesResponse.json();
                
                const caseListDiv = document.getElementById('case-list');
                if (casesList.cases && casesList.cases.length > 0) {
                    caseListDiv.innerHTML = casesList.cases.map(clinicalCase => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">${clinicalCase.specialty}</h4>
                                    <p class="text-sm text-gray-600 mt-1">${clinicalCase.patient_presentation.substring(0, 150)}...</p>
                                    <div class="mt-2 flex items-center space-x-3 text-xs text-gray-500">
                                        <span><i class="fas fa-user mr-1"></i>√Çge: ${clinicalCase.age || 'N/A'}</span>
                                        <span><i class="fas fa-venus-mars mr-1"></i>${clinicalCase.gender || 'N/A'}</span>
                                    </div>
                                </div>
                                <button onclick="viewCase('${clinicalCase.id}')" class="ml-4 text-purple-600 hover:text-purple-800">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    caseListDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun cas clinique disponible. G√©n√©rez-en un !</p>';
                }
                
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        // Load Evaluations
        async function loadEvaluations() {
            try {
                const response = await fetch(`${API_BASE}/admin/doctors`);
                const data = await response.json();
                
                if (!data.success) return;
                
                const tbody = document.getElementById('evaluations-table-body');
                const evaluations = [];
                
                // Get all evaluations for all doctors
                for (const doctor of data.doctors) {
                    if (doctor.evaluation_status) {
                        evaluations.push({
                            doctor_name: doctor.name,
                            doctor_email: doctor.email,
                            evaluation_date: doctor.evaluation_date,
                            tmcq_total: doctor.tmcq_total,
                            status: doctor.evaluation_status
                        });
                    }
                }
                
                if (evaluations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Aucune √©valuation disponible</td></tr>';
                    return;
                }
                
                tbody.innerHTML = evaluations.map(eval => {
                    const statusBadge = getStatusBadge(eval.status);
                    const score = eval.tmcq_total ? eval.tmcq_total.toFixed(1) : 'N/A';
                    const date = eval.evaluation_date ? new Date(eval.evaluation_date).toLocaleDateString('fr-FR') : 'N/A';
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">
                                <div class="font-semibold">${eval.doctor_name}</div>
                                <div class="text-xs text-gray-500">${eval.doctor_email}</div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">${date}</td>
                            <td class="px-4 py-3 text-sm font-bold text-blue-600">${score}</td>
                            <td class="px-4 py-3 text-sm">N/A</td>
                            <td class="px-4 py-3 text-sm">N/A</td>
                            <td class="px-4 py-3 text-sm">${statusBadge}</td>
                            <td class="px-4 py-3 text-sm">
                                <button class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Failed to load evaluations:', error);
            }
        }

        // Generate QCM
        function showGenerateQCMModal() {
            document.getElementById('generate-qcm-modal').classList.remove('hidden');
            document.getElementById('generate-qcm-modal').classList.add('flex');
        }

        function hideGenerateQCMModal() {
            document.getElementById('generate-qcm-modal').classList.add('hidden');
            document.getElementById('generate-qcm-modal').classList.remove('flex');
        }

        // Update time estimate when QCM count changes
        // G√©n√©ration UNIQUEMENT 1 par 1 (pas de calcul dynamique)

        async function generateQCM(event) {
            event.preventDefault();
            
            const count = 1;  // TOUJOURS 1 seul QCM
            const theme = document.getElementById('qcm-theme').value;
            const difficulty = document.getElementById('qcm-difficulty').value;
            
            hideGenerateQCMModal();
            
            // Show loading
            const qcmListDiv = document.getElementById('qcm-list');
            qcmListDiv.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
                    <p class="text-xl font-semibold text-gray-900 mb-2">G√©n√©ration d'1 QCM...</p>
                    <p class="text-gray-600 mb-4">Th√®me: "${theme}" | Difficult√©: ${difficulty}</p>
                    <div class="bg-blue-50 rounded-lg p-4 max-w-md mx-auto">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-clock mr-2"></i>
                            Temps estim√©: 30-60 secondes
                        </p>
                    </div>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/generate/qcm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        theme, 
                        difficulty,
                        count 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ 1 QCM g√©n√©r√© avec succ√®s !');
                    loadContent();
                    loadDashboard();
                } else {
                    alert('‚ùå ' + (data.error || 'Erreur lors de la g√©n√©ration'));
                    loadContent();
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
                loadContent();
            }
        }

        // Generate Clinical Case
        function showGenerateCaseModal() {
            document.getElementById('generate-case-modal').classList.remove('hidden');
            document.getElementById('generate-case-modal').classList.add('flex');
        }

        function hideGenerateCaseModal() {
            document.getElementById('generate-case-modal').classList.add('hidden');
            document.getElementById('generate-case-modal').classList.remove('flex');
        }

        async function generateClinicalCase(event) {
            event.preventDefault();
            
            const count = 1;  // TOUJOURS 1 seul cas
            const specialty = document.getElementById('case-specialty').value;
            const complexity = document.getElementById('case-complexity').value;
            
            hideGenerateCaseModal();
            
            // Show loading
            const caseListDiv = document.getElementById('case-list');
            caseListDiv.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-5xl text-purple-600 mb-4"></i>
                    <p class="text-xl font-semibold text-gray-900 mb-2">G√©n√©ration d'1 cas clinique...</p>
                    <p class="text-gray-600 mb-4">Sp√©cialit√©: "${specialty}" | Complexit√©: ${complexity}</p>
                    <div class="bg-purple-50 rounded-lg p-4 max-w-md mx-auto">
                        <p class="text-sm text-purple-800">
                            <i class="fas fa-clock mr-2"></i>
                            Temps estim√©: 45-90 secondes
                        </p>
                    </div>
                </div>
            `;
            
            try {
                // UN SEUL appel API pour g√©n√©rer TOUS les cas
                const response = await fetch(`${API_BASE}/generate/clinical-case`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        specialty, 
                        complexity,
                        count 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ 1 cas clinique g√©n√©r√© avec succ√®s !');
                    loadContent();
                    loadDashboard();
                } else {
                    alert('‚ùå ' + (data.error || 'Erreur lors de la g√©n√©ration'));
                    loadContent();
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
                loadContent();
            }
        }

        function viewQCM(qcmId) {
            window.open(`/static/qcm-detail.html?id=${qcmId}`, '_blank');
        }

        function viewCase(caseId) {
            window.open(`/static/case-detail.html?id=${caseId}`, '_blank');
        }

        // Evaluations Setup Functions
        let selectedQCMs = [];
        let selectedCases = [];

        async function loadEvaluationsSetup() {
            try {
                const response = await fetch(`${API_BASE}/evaluations/templates`);
                const data = await response.json();
                
                if (!data.success) return;
                
                const listDiv = document.getElementById('evaluations-list');
                
                if (!data.templates || data.templates.length === 0) {
                    listDiv.innerHTML = `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <i class="fas fa-clipboard-list text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-600 mb-4">Aucune √©valuation cr√©√©e</p>
                            <button onclick="showCreateEvaluationModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Cr√©er votre premi√®re √©valuation
                            </button>
                        </div>
                    `;
                    return;
                }
                
                listDiv.innerHTML = data.templates.map(template => `
                    <div class="border border-gray-200 rounded-lg p-6 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-900">${template.name}</h3>
                                    <span class="px-3 py-1 ${template.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} rounded-full text-xs font-semibold">
                                        ${template.is_active ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                                    </span>
                                </div>
                                ${template.description ? `<p class="text-gray-600 mb-3">${template.description}</p>` : ''}
                                <div class="flex items-center space-x-6 text-sm text-gray-600">
                                    <span><i class="fas fa-clock mr-1"></i>${template.duration_minutes} min</span>
                                    <span><i class="fas fa-percentage mr-1"></i>Score min: ${template.passing_score}%</span>
                                    <span><i class="fas fa-question-circle mr-1 text-green-600"></i>${template.qcm_count} QCM</span>
                                    <span><i class="fas fa-file-medical mr-1 text-purple-600"></i>${template.case_count} Cas</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="viewEvaluation('${template.id}')" class="px-3 py-2 text-blue-600 hover:bg-blue-50 rounded" title="Voir">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="toggleEvaluation('${template.id}', ${template.is_active ? 0 : 1})" class="px-3 py-2 text-yellow-600 hover:bg-yellow-50 rounded" title="${template.is_active ? 'D√©sactiver' : 'Activer'}">
                                    <i class="fas fa-power-off"></i>
                                </button>
                                <button onclick="deleteEvaluation('${template.id}', '${template.name}')" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load evaluations:', error);
            }
        }

        function showCreateEvaluationModal() {
            selectedQCMs = [];
            selectedCases = [];
            document.getElementById('create-evaluation-modal').classList.remove('hidden');
            document.getElementById('create-evaluation-modal').classList.add('flex');
            loadAvailableQCM();
            loadAvailableCases();
        }

        function hideCreateEvaluationModal() {
            document.getElementById('create-evaluation-modal').classList.add('hidden');
            document.getElementById('create-evaluation-modal').classList.remove('flex');
        }

        async function loadAvailableQCM() {
            try {
                const response = await fetch(`${API_BASE}/generate/qcm/random?count=50`);
                const data = await response.json();
                
                const listDiv = document.getElementById('qcm-selection-list');
                
                if (!data.qcms || data.qcms.length === 0) {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun QCM disponible. G√©n√©rez-en d\'abord !</p>';
                    return;
                }
                
                listDiv.innerHTML = data.qcms.map(qcm => `
                    <label class="flex items-start p-3 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="${qcm.id}" onchange="updateSelectedQCM(this)" class="mt-1 mr-3">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${qcm.theme || qcm.topic}</div>
                            <div class="text-sm text-gray-600">${qcm.question.substring(0, 100)}...</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span class="mr-3">${qcm.difficulty || 'N/A'}</span>
                                <span>${qcm.source}</span>
                            </div>
                        </div>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Failed to load QCM:', error);
            }
        }

        async function loadAvailableCases() {
            try {
                const response = await fetch(`${API_BASE}/generate/clinical-case/random?count=20`);
                const data = await response.json();
                
                const listDiv = document.getElementById('cases-selection-list');
                
                if (!data.cases || data.cases.length === 0) {
                    listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun cas clinique disponible. G√©n√©rez-en d\'abord !</p>';
                    return;
                }
                
                listDiv.innerHTML = data.cases.map(clinicalCase => `
                    <label class="flex items-start p-3 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="${clinicalCase.id}" onchange="updateSelectedCases(this)" class="mt-1 mr-3">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">${clinicalCase.title || clinicalCase.specialty}</div>
                            <div class="text-sm text-gray-600">${clinicalCase.presentation.substring(0, 100)}...</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span class="mr-3">${clinicalCase.specialty}</span>
                                <span>${clinicalCase.complexity || 'N/A'}</span>
                            </div>
                        </div>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Failed to load cases:', error);
            }
        }

        function updateSelectedQCM(checkbox) {
            if (checkbox.checked) {
                selectedQCMs.push(checkbox.value);
            } else {
                selectedQCMs = selectedQCMs.filter(id => id !== checkbox.value);
            }
            document.getElementById('selected-qcm-count').textContent = selectedQCMs.length;
        }

        function updateSelectedCases(checkbox) {
            if (checkbox.checked) {
                selectedCases.push(checkbox.value);
            } else {
                selectedCases = selectedCases.filter(id => id !== checkbox.value);
            }
            document.getElementById('selected-cases-count').textContent = selectedCases.length;
        }

        async function createEvaluation(event) {
            event.preventDefault();
            
            const name = document.getElementById('eval-name').value;
            const description = document.getElementById('eval-description').value;
            const duration_minutes = parseInt(document.getElementById('eval-duration').value);
            const passing_score = parseFloat(document.getElementById('eval-passing-score').value);
            
            if (selectedQCMs.length === 0 && selectedCases.length === 0) {
                alert('‚ùå Vous devez s√©lectionner au moins un QCM ou un cas clinique');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/evaluations/templates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        duration_minutes,
                        passing_score,
                        qcm_ids: selectedQCMs,
                        case_ids: selectedCases
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ √âvaluation cr√©√©e avec succ√®s !');
                    hideCreateEvaluationModal();
                    loadEvaluationsSetup();
                } else {
                    alert('‚ùå ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        async function toggleEvaluation(templateId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/evaluations/templates/${templateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadEvaluationsSetup();
                } else {
                    alert('‚ùå ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        async function deleteEvaluation(templateId, templateName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'√©valuation "${templateName}" ?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/evaluations/templates/${templateId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ √âvaluation supprim√©e');
                    loadEvaluationsSetup();
                } else {
                    alert('‚ùå ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        function viewEvaluation(templateId) {
            alert('Vue d√©taill√©e de l\'√©valuation: ' + templateId + '\n(Fonctionnalit√© √† venir)');
        }

        // Helper Functions
        function getStatusBadge(status) {
            if (status === 'apte') {
                return '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">‚úÖ Apte</span>';
            } else if (status === 'supervision_requise') {
                return '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">‚ö†Ô∏è Supervision</span>';
            } else if (status === 'formation_requise') {
                return '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">‚ùå Formation</span>';
            }
            return '<span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">Non √©valu√©</span>';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            showTab('dashboard');
            loadConfig();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Direct Evaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
            <h1 class="text-2xl font-bold mb-6">üîç Test Direct - D√©marrer √âvaluation</h1>
            
            <div class="space-y-4">
                <!-- Step 1: Login -->
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h2 class="font-bold text-lg mb-3">√âtape 1: Se connecter</h2>
                    <button onclick="doLogin()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        üîê Connexion automatique
                    </button>
                    <div id="login-status" class="mt-2 text-sm"></div>
                </div>

                <!-- Step 2: Start Evaluation -->
                <div class="p-4 bg-green-50 rounded-lg">
                    <h2 class="font-bold text-lg mb-3">√âtape 2: D√©marrer l'√©valuation</h2>
                    <button onclick="startEval()" id="start-btn" disabled class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        üöÄ D√©marrer √âvaluation Test
                    </button>
                    <div id="eval-status" class="mt-2 text-sm"></div>
                </div>

                <!-- Results -->
                <div class="p-4 bg-gray-100 rounded-lg">
                    <h2 class="font-bold text-lg mb-3">üìã R√©sultat</h2>
                    <pre id="result" class="text-xs bg-gray-800 text-green-400 p-4 rounded overflow-auto max-h-96"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = null;

        async function doLogin() {
            const statusEl = document.getElementById('login-status');
            statusEl.innerHTML = '<span class="text-blue-600">‚è≥ Connexion en cours...</span>';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'dr.jean.martin@tibok.mu',
                        password: 'password123'
                    })
                });

                const data = await response.json();

                if (data.success && data.token) {
                    token = data.token;
                    localStorage.setItem('doctor_token', token);
                    statusEl.innerHTML = '<span class="text-green-600">‚úÖ Connect√© ! Token stock√©.</span>';
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('result').textContent = 'Token: ' + token.substring(0, 50) + '...';
                } else {
                    statusEl.innerHTML = '<span class="text-red-600">‚ùå √âchec: ' + (data.error || 'Erreur inconnue') + '</span>';
                    document.getElementById('result').textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                statusEl.innerHTML = '<span class="text-red-600">‚ùå Erreur: ' + error.message + '</span>';
                document.getElementById('result').textContent = error.stack;
            }
        }

        async function startEval() {
            const statusEl = document.getElementById('eval-status');
            statusEl.innerHTML = '<span class="text-green-600">‚è≥ Chargement de l\'√©valuation...</span>';

            if (!token) {
                token = localStorage.getItem('doctor_token');
                if (!token) {
                    statusEl.innerHTML = '<span class="text-red-600">‚ùå Pas de token. Connectez-vous d\'abord.</span>';
                    return;
                }
            }

            try {
                const response = await fetch('/api/evaluations/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        template_id: 'eval-test-001'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.innerHTML = '<span class="text-green-600">‚úÖ √âvaluation charg√©e avec succ√®s !</span>';
                    document.getElementById('result').textContent = 
                        '‚úÖ SUCC√àS !\n\n' +
                        '√âvaluation: ' + data.evaluation.name + '\n' +
                        'Dur√©e: ' + data.evaluation.duration_minutes + ' minutes\n' +
                        'QCM: ' + data.evaluation.qcms.length + '\n' +
                        'Cas cliniques: ' + data.evaluation.cases.length + '\n\n' +
                        'Premier QCM:\n' + 
                        JSON.stringify(data.evaluation.qcms[0], null, 2);
                } else {
                    statusEl.innerHTML = '<span class="text-red-600">‚ùå √âchec: ' + (data.error || 'Erreur inconnue') + '</span>';
                    document.getElementById('result').textContent = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                statusEl.innerHTML = '<span class="text-red-600">‚ùå Erreur: ' + error.message + '</span>';
                document.getElementById('result').textContent = error.stack;
            }
        }

        // Auto-check if token exists
        window.addEventListener('load', () => {
            const existingToken = localStorage.getItem('doctor_token');
            if (existingToken) {
                token = existingToken;
                document.getElementById('login-status').innerHTML = '<span class="text-green-600">‚úÖ Token d√©j√† pr√©sent dans localStorage</span>';
                document.getElementById('start-btn').disabled = false;
                document.getElementById('result').textContent = 'Token existant: ' + token.substring(0, 50) + '...';
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>D√©marrage √âvaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Pr√©paration de l'√©valuation...</h1>
                <p class="text-gray-600" id="status">V√©rification du token...</p>
            </div>
            <div id="error" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-left">
                <p class="text-sm text-red-800 font-semibold mb-2">‚ùå Erreur</p>
                <pre class="text-xs text-red-600 overflow-auto"></pre>
            </div>
        </div>
    </div>

    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        const API_BASE = '/api';
        
        async function init() {
            const statusEl = document.getElementById('status');
            const errorEl = document.getElementById('error');
            
            try {
                // Check token
                let token = localStorage.getItem('doctor_token');
                
                if (!token) {
                    statusEl.textContent = 'Connexion automatique...';
                    
                    // Auto login
                    const loginResp = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'dr.jean.martin@tibok.mu',
                            password: 'password123'
                        })
                    });
                    
                    const loginData = await loginResp.json();
                    
                    if (!loginData.success) {
                        throw new Error('√âchec de connexion: ' + (loginData.error || 'Erreur inconnue'));
                    }
                    
                    token = loginData.token;
                    localStorage.setItem('doctor_token', token);
                }
                
                // Start evaluation
                statusEl.textContent = 'Chargement de l\'√©valuation...';
                
                const response = await fetch(`${API_BASE}/evaluations/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        template_id: 'eval-test-001'
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Impossible de charger l\'√©valuation');
                }
                
                // Transform evaluation data for frontend
                const evaluation = data.evaluation;
                
                // Transform QCM options from array to object (A, B, C, D, E)
                console.log('Transforming QCMs...', evaluation.qcms.length);
                evaluation.qcms = evaluation.qcms.map((qcm, qcmIdx) => {
                    try {
                        const optionsObj = {};
                        if (Array.isArray(qcm.options)) {
                            qcm.options.forEach((opt, idx) => {
                                const letter = String.fromCharCode(65 + idx); // A, B, C, D, E
                                // Ensure opt is a string
                                const optStr = typeof opt === 'string' ? opt : String(opt);
                                optionsObj[letter] = optStr.replace(/^[A-E]\)\s*/, ''); // Remove "A) " prefix if exists
                            });
                        } else {
                            console.error('QCM options not array:', qcm.id, typeof qcm.options);
                            // If options is already an object, use it as-is
                            optionsObj = qcm.options;
                        }
                        return { ...qcm, options: optionsObj };
                    } catch (err) {
                        console.error('Error transforming QCM', qcmIdx, err);
                        throw err;
                    }
                });
                
                // Transform clinical cases questions
                console.log('Transforming cases...', evaluation.cases.length);
                evaluation.cases = evaluation.cases.map((caseItem, caseIdx) => {
                    try {
                        const transformedQuestions = [];
                        console.log(`Case ${caseIdx}: questions type =`, typeof caseItem.questions, Array.isArray(caseItem.questions));
                        if (Array.isArray(caseItem.questions) && caseItem.questions.length > 0) {
                            caseItem.questions.forEach((q, idx) => {
                                // Validate question structure
                                if (q && (q.question || q.q)) {
                                    // Use existing options if available, otherwise create default
                                    const options = q.options || {
                                        'A': 'Option A',
                                        'B': 'Option B',
                                        'C': 'Option C',
                                        'D': 'Option D'
                                    };
                                    
                                    transformedQuestions.push({
                                        q: q.question || q.q,
                                        options: options,
                                        correct: q.correct || 'A'
                                    });
                                } else {
                                    console.warn(`Case ${caseIdx}, question ${idx}: invalid structure`, q);
                                }
                            });
                        } else {
                            console.warn(`Case ${caseIdx}: questions not an array or empty`, caseItem.questions);
                        }
                        return { ...caseItem, questions: transformedQuestions };
                    } catch (err) {
                        console.error('Error transforming case', caseIdx, err);
                        throw err;
                    }
                });
                
                // Store transformed evaluation data
                sessionStorage.setItem('current_evaluation', JSON.stringify(evaluation));
                
                // Redirect to take evaluation page
                statusEl.textContent = '‚úÖ √âvaluation pr√™te ! Redirection...';
                
                setTimeout(() => {
                    window.location.href = '/static/take-evaluation-simple.html';
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                console.error('Stack:', error.stack);
                errorEl.classList.remove('hidden');
                
                // Detailed error message
                const errorDetails = [
                    '‚ùå Message: ' + error.message,
                    '',
                    'üìç Line: ' + (error.lineNumber || 'Unknown'),
                    'üìç Column: ' + (error.columnNumber || 'Unknown'),
                    '',
                    'üîç Stack Trace:',
                    error.stack || 'N/A',
                    '',
                    'üêõ Debug Info:',
                    '- Token: ' + (token ? 'Present (length: ' + token.length + ')' : 'Missing'),
                    '- Window: ' + window.location.href,
                    '- User Agent: ' + navigator.userAgent.substring(0, 50) + '...'
                ].join('\n');
                
                errorEl.querySelector('pre').textContent = errorDetails;
                statusEl.textContent = '‚ùå Erreur lors du chargement de l\'√©valuation';
                
                // Also alert for visibility
                alert('‚ùå Erreur d√©taill√©e:\n\n' + error.message + '\n\nVoir la console (F12) pour plus de d√©tails.');
            }
        }
        
        // Start automatically
        init();
    </script>
</body>
</html>

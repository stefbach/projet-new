<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion - Tibok Medical Evaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
        <!-- Logo / Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-full mb-4">
                <i class="fas fa-user-md text-3xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">Tibok Medical Evaluation</h1>
            <p class="text-gray-600 mt-2">Système d'évaluation médicale</p>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button onclick="showTab('login')" id="tab-login-btn" class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-blue-600 text-blue-600">
                Connexion
            </button>
            <button onclick="showTab('register')" id="tab-register-btn" class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                Inscription
            </button>
        </div>

        <!-- Login Form -->
        <form id="login-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="login-email" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="dr.martin@tibok.mu">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                <input type="password" id="login-password" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="••••••••">
            </div>
            <button type="submit" 
                class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                <i class="fas fa-sign-in-alt mr-2"></i>Se connecter
            </button>
        </form>

        <!-- Register Form (hidden by default) -->
        <form id="register-form" class="space-y-4 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nom complet</label>
                <input type="text" id="register-name" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Dr. Jean Martin">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="register-email" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="dr.martin@tibok.mu">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                <input type="password" id="register-password" required minlength="8"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Minimum 8 caractères">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Spécialité</label>
                <input type="text" id="register-specialty"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Médecine Générale">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de licence (optionnel)</label>
                <input type="text" id="register-license"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="MMC-2020-1234">
            </div>
            <button type="submit" 
                class="w-full py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition">
                <i class="fas fa-user-plus mr-2"></i>Créer un compte
            </button>
        </form>

        <!-- Message -->
        <div id="message" class="mt-4 hidden"></div>

        <!-- Admin Link -->
        <div class="mt-6 text-center text-sm text-gray-600">
            Administrateur ? 
            <a href="/" class="text-blue-600 hover:underline">Accéder au dashboard admin</a>
        </div>
    </div>

    <script>
        const API_BASE = '/api'

        // Tab management
        function showTab(tab) {
            const loginForm = document.getElementById('login-form')
            const registerForm = document.getElementById('register-form')
            const loginBtn = document.getElementById('tab-login-btn')
            const registerBtn = document.getElementById('tab-register-btn')

            if (tab === 'login') {
                loginForm.classList.remove('hidden')
                registerForm.classList.add('hidden')
                loginBtn.classList.add('border-blue-600', 'text-blue-600')
                loginBtn.classList.remove('border-transparent', 'text-gray-500')
                registerBtn.classList.remove('border-blue-600', 'text-blue-600')
                registerBtn.classList.add('border-transparent', 'text-gray-500')
            } else {
                loginForm.classList.add('hidden')
                registerForm.classList.remove('hidden')
                registerBtn.classList.add('border-blue-600', 'text-blue-600')
                registerBtn.classList.remove('border-transparent', 'text-gray-500')
                loginBtn.classList.remove('border-blue-600', 'text-blue-600')
                loginBtn.classList.add('border-transparent', 'text-gray-500')
            }
        }

        // Show message
        function showMessage(text, type = 'error') {
            const msg = document.getElementById('message')
            msg.className = `mt-4 p-4 rounded-lg ${type === 'error' ? 'bg-red-50 text-red-800 border border-red-200' : 'bg-green-50 text-green-800 border border-green-200'}`
            msg.textContent = text
            msg.classList.remove('hidden')
            
            setTimeout(() => msg.classList.add('hidden'), 5000)
        }

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault()
            const btn = e.target.querySelector('button[type="submit"]')
            btn.disabled = true
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connexion...'

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('login-email').value,
                        password: document.getElementById('login-password').value
                    })
                })

                const data = await response.json()

                if (!response.ok) {
                    throw new Error(data.error || 'Échec de la connexion')
                }

                // Store token
                localStorage.setItem('tibok_token', data.token)
                localStorage.setItem('tibok_user', JSON.stringify(data.doctor))

                showMessage('Connexion réussie ! Redirection...', 'success')

                // Redirect based on role
                setTimeout(() => {
                    if (data.doctor.role === 'admin') {
                        window.location.href = '/'
                    } else {
                        window.location.href = '/static/doctor-dashboard.html'
                    }
                }, 1000)
            } catch (error) {
                showMessage(error.message)
            } finally {
                btn.disabled = false
                btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Se connecter'
            }
        })

        // Register
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault()
            const btn = e.target.querySelector('button[type="submit"]')
            btn.disabled = true
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Création...'

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('register-name').value,
                        email: document.getElementById('register-email').value,
                        password: document.getElementById('register-password').value,
                        specialty: document.getElementById('register-specialty').value,
                        license_number: document.getElementById('register-license').value
                    })
                })

                const data = await response.json()

                if (!response.ok) {
                    throw new Error(data.error || 'Échec de l\'inscription')
                }

                // Store token
                localStorage.setItem('tibok_token', data.token)
                localStorage.setItem('tibok_user', JSON.stringify(data.doctor))

                showMessage('Compte créé ! Redirection...', 'success')

                setTimeout(() => {
                    window.location.href = '/static/doctor-dashboard.html'
                }, 1000)
            } catch (error) {
                showMessage(error.message)
            } finally {
                btn.disabled = false
                btn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Créer un compte'
            }
        })

        // Check if already logged in
        if (localStorage.getItem('tibok_token')) {
            const user = JSON.parse(localStorage.getItem('tibok_user') || '{}')
            if (user.role === 'admin') {
                window.location.href = '/'
            } else {
                window.location.href = '/static/doctor-dashboard.html'
            }
        }
    </script>
</body>
</html>
